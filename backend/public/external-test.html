<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IoT External Device Test - ‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏†‡∏≤‡∏¢‡∏ô‡∏≠‡∏Å</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; padding: 20px; margin: 0; background: #f5f7fa; }
        .container { max-width: 800px; margin: 0 auto; }
        .header { background: #2c3e50; color: white; padding: 20px; border-radius: 10px; margin-bottom: 20px; }
        .status { padding: 15px; margin: 10px 0; border-radius: 8px; font-weight: bold; }
        .connected { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .disconnected { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .connecting { background: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }
        .data-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 15px; margin: 20px 0; }
        .data-card { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); border-left: 4px solid #3498db; }
        .data-card h3 { margin: 0 0 10px 0; color: #2c3e50; }
        .data-value { font-size: 24px; font-weight: bold; color: #e74c3c; }
        .data-unit { font-size: 14px; color: #7f8c8d; }
        .log { background: #2c3e50; color: #ecf0f1; padding: 15px; border-radius: 8px; font-family: monospace; height: 200px; overflow-y: auto; margin: 20px 0; }
        .timestamp { color: #3498db; }
        .info { background: #e8f5e8; padding: 15px; border-radius: 8px; margin: 20px 0; border-left: 4px solid #27ae60; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üåê IoT External Device Test</h1>
            <p>‡∏Å‡∏≤‡∏£‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏à‡∏≤‡∏Å‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏†‡∏≤‡∏¢‡∏ô‡∏≠‡∏Å</p>
        </div>
        
        <div class="info">
            <strong>URL ‡∏ô‡∏µ‡πâ:</strong> <span id="currentUrl"></span><br>
            <strong>Backend URL:</strong> <span id="backendUrl"></span>
        </div>
        
        <div id="status" class="status disconnected">üî¥ ‡πÑ‡∏°‡πà‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠</div>
        
        <div class="data-grid">
            <div class="data-card">
                <h3>üíß Flow Rate Devices (3)</h3>
                <div class="data-value" id="flowRate">---</div>
                <div class="data-unit">L/h</div>
            </div>
            <div class="data-card">
                <h3>‚ö° ORP Devices (6)</h3>
                <div class="data-value" id="orpLevel">---</div>
                <div class="data-unit">mV</div>
            </div>
            <div class="data-card">
                <h3>üß™ pH Devices (6)</h3>
                <div class="data-value" id="pHLevel">---</div>
                <div class="data-unit">pH</div>
            </div>
            <div class="data-card">
                <h3>üîå Power Meter (1)</h3>
                <div class="data-value" id="powerConsumption">---</div>
                <div class="data-unit">kW</div>
            </div>
        </div>
        
        <div id="log" class="log">
            <div class="timestamp">[‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠...]</div>
        </div>
    </div>
    
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <script>
        const currentUrl = window.location.href;
        const hostname = window.location.hostname;
        const backendHost = hostname === 'localhost' || hostname === '127.0.0.1' ? 'localhost' : '148.135.137.236';
        const backendUrl = `http://${backendHost}:3001`;
        
        document.getElementById('currentUrl').textContent = currentUrl;
        document.getElementById('backendUrl').textContent = backendUrl;
        
        const log = document.getElementById('log');
        const statusDiv = document.getElementById('status');
        
        function addLog(message, type = 'info') {
            const timestamp = new Date().toLocaleString('th-TH');
            const logEntry = document.createElement('div');
            logEntry.innerHTML = `<span class="timestamp">[${timestamp}]</span> ${message}`;
            log.appendChild(logEntry);
            log.scrollTop = log.scrollHeight;
            console.log(message);
        }
        
        addLog('üöÄ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠...');
        addLog(`üì° ‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏°‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÑ‡∏õ‡∏ó‡∏µ‡πà: ${backendUrl}`);
        
        const socket = io(backendUrl, {
            transports: ['polling', 'websocket']
        });
        
        socket.on('connect', () => {
            addLog('‚úÖ ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! Socket ID: ' + socket.id);
            statusDiv.textContent = 'üü¢ ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÅ‡∏•‡πâ‡∏ß';
            statusDiv.className = 'status connected';
        });
        
        socket.on('disconnect', (reason) => {
            addLog('‚ùå ‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Ç‡∏≤‡∏î‡∏´‡∏≤‡∏¢: ' + reason);
            statusDiv.textContent = 'üî¥ ‡πÑ‡∏°‡πà‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠';
            statusDiv.className = 'status disconnected';
        });
        
        socket.on('connect_error', (error) => {
            addLog('üî¥ ‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠: ' + error.message);
            statusDiv.textContent = 'üî¥ ‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠';
            statusDiv.className = 'status disconnected';
        });
        
        socket.on('deviceData', (data) => {
            addLog('üìä ‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏∏‡∏Å‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ');
            document.getElementById('flowRate').textContent = data.flowRate;
            document.getElementById('orpLevel').textContent = data.orpLevel;
            document.getElementById('pHLevel').textContent = data.pHLevel;
            document.getElementById('powerConsumption').textContent = data.powerConsumption;
        });
        
        socket.on('activityLog', (activity) => {
            addLog(`üìù ${activity.device}: ${activity.message}`);
        });
        
        // Timeout check
        setTimeout(() => {
            if (!socket.connected) {
                addLog('‚è∞ ‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÉ‡∏ä‡πâ‡πÄ‡∏ß‡∏•‡∏≤‡∏ô‡∏≤‡∏ô‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ - ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö firewall ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏Ñ‡∏£‡∏∑‡∏≠‡∏Ç‡πà‡∏≤‡∏¢');
            }
        }, 10000);
    </script>
</body>
</html>
